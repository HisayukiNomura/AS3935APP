@mainpage 雷センサー　AE-AS3935＋Raspberry pi PICO

# 雷センサー　AE-AS3935＋Raspberry pi PICO

---

# 概要

秋月電子のAE-AS3935雷センサーを使用したRaspberry pi PICO Wでの作例です。
AS-AE3935は、AMS社のAS3935雷センサーICを搭載したモジュールで、雷の発生を検知し、雷雲までの距離や雷のエネルギーを推定できるデバイスです。秋月電子で販売されており、I2Cを使用して外部に情報を送信します。

主な特徴：
- 検出範囲：最大約40km先の雷を検知
- インターフェース：I²C（秋月電子のモジュールではSPIは未実装）
- 出力：雷検出時にIRQ信号を出力
- 電源電圧：2.4V〜5.5V
- 消費電流：待機時 約70μA、検出時 約350μA
- ノイズ除去機能：人工ノイズと自然雷を区別
- 距離推定：14段階で雷雲までの距離を出力

本プロジェクトは、この[AE-AS3935](https://akizukidenshi.com/catalog/g/g108685/)と、ILI9341搭載の2.8インチSPITFT液晶、[MSP2807](https://akizukidenshi.com/catalog/g/g116265/)を使用した、雷センサーのプログラムです。

---

# 主な特徴

- **TFT液晶のタッチ機能によるユーザーインタフェース**<br/>
[MSP2807](https://akizukidenshi.com/catalog/g/g116265/) のタッチスクリーンを使用し、画面上に入力機能やボタンなどを装備し、設定は本体のみで完結。

- **SNTPを使用して現在時刻を取得、表示**<br/>
Raspberry pi PICO W/2W のWifi機能を使用し、起動時の現在時刻をpool.ntp.orgから取得し、画面に時計を表示

---

# 使用ライブラリ構成

**グラフィック液晶ライブラリ**
[Rapberry PI Pico 用　ILI9341 TFT液晶 日本語ライブラリ](https://qiita.com/BUBUBB/items/7c6777c04dedf01d7c3b)


---


# 使い方

## 初期化

起動すると、最初に初期化画面が表示され、初期化の状況が表示されます。初期化が終わると自動的に次に進みます。

初期化される項目は次の通りです。初期化中の状態を確認し、×がある場合には問題を確認してください。

1. AS3935
2. WIFI初期化
3. WIFI接続
4. タイムゾーン取得
5. AS3935 のキャリブレーション

初期化中に、スクリーンをタッチし続けると、設定を初期化できます。


## 監視画面

監視画面では時計が表示されます。雷を検知すると、画面に時刻、発生源と雷雲までの概算距離が表示されます。

ここで表示される距離は実際に落雷があった場所までの距離示すものではありません。統計的に、雷雲の先端と現在位置の距離を算出したものです。

発生源は次のようになっています。
- なし　…　信号が存在しません。予期しない誤検出です。
- 雷　…　雷雲を検出しました。雷雲までの距離が表示されます。
- 距離超 …　雷雲を検出しましたが距離が遠すぎます。
- 距離０ …　雷雲を検出しましたが距離がゼロです。
- 誤信号 …　蛍光灯やモーターなどにより誤検出が発生しました。距離はーーーとなり表示されません。
- 雑音多 …　ノイズが多すぎて発生源を特定できません。

画面最上段のバーをタップすると設定画面が表示されます。

### 設定画面

#### メインメニュー
- システム設定　…　時刻表示や現在日時の設定を行います
- AS3935設定 …　AS3935の各種パラメータを変更します。変更した後は再起動が必要になります。
- ネットワーク設定 …　WIFIの設定を行います。
- タッチパネルの調整 …　タッチパネルのキャリブレーションを行います。タッチ位置がずれていると感じたときに調整を行ってください。


#### システム設定

- 時刻表示　…　12H/24Hの切り替え。タップすると12時間表示と24時間表示が切り替わります。
- 日時　…　YYYYMMDDHHmmSS の形式で、現在時刻を指定します。たとえば2025/7/1 20:05:00 の場合、20250701200500　と入力します。
- デバッグ … ターミナル(TERM)となし(----)、を切り替えます。ターミナルを指定すると、実行状況がシリアル出力されます。シリアルポートはUART0で、GPIO0がTX、GPIO2がRX、ボーレートは115200です。

#### AS3935設定
ここでは、雷センサーに関する設定を行います。i2Cアドレスと読み込み方法の他は、主に雷センサーの感度調整や、ノイズの除去に関する設定です。

- I2C addr …　I2Cアドレスを指定します。１～３が指定できます。デフォルトは３です。秋月電子のAE-AS3935は初期ロットは０、後期ロットは３です。
- ReadMode …　Single/Blockが指定できます。デフォルトはSingleです。SingleはI2Cリードを必要な場所ごとに分けて発行します。Blockは、すべてのレジスタを一回の読み込みで読み込みます。どちらを指定しても結果は同じです。Singleリードで正しく読み込めない場合、ブロックリードを指定します。ブロックリードをサポートしていないデバイスの場合Singleを指定します。
- GAINBOOST …　AFE（アナログフロントエンド）のゲインブースト値を０～３１で指定します。デフォルトは１８（屋内）です。屋外で使用する場合は１４を指定します。
- NOISEFLR …　ノイズ下限水準（ノイズフロアレベル）を０～７で指定します。デフォルト値は２です。この値と、AFEゲインブースト値で、ノイズ下限水準値が決定します。（例えば、デフォルト値である２で、AFEゲインブーストが18のときは、62μVrms）ノイズ下限水準より高いノイズが検出されるとノイズレベルが高すぎて動作ができないという信号が発生します。画面には「雑音多」と表示されます
- WATCHDOG … ウオッチドッグ閾値を０～１０で指定します。デフォルトは２です。ウオッチドックは、AFEが出力している検出信号を監視し、信号がウオッチドッグ閾値で指定された値を超えたら、その信号を検出モードに移行させます。検出モードでは、スパイクの除去などを行い、誤検出を排除します。<br>
ウオッチドッグ閾値を上げると、雑音などの誤検出に強くなりますが弱い雷の検出能力が下がります。<br>ウォッチドッグ閾値を下げると、ノイズの検出が増えますが逆に遠くの雷の検出能力が高くなります。
- MINLIGHT　…　雷の最小検出数を、１、５、９、１６で指定します。デフォルトは０です。雷の信号を検知しても、最新の１５分間以内にここで指定した数を超えないと、雷として検知しません。これは、人工的に発生するノイズによる誤警告を避けるための設定です。
- SPIKEREJ　…　スパイク除去設定を、０～１１で指定します。デフォルトは２です。<br>
スパイク除去設定を上げると、雑音の除去が協力になり誤検出は減りますが、検出効率は下がります。<br>スパイク除去設定を下げると、雑音による誤検出が増えますが、検出効率は上がります。


#### ネットワーク設定
ここでは、WIFIに関する設定を行います。

- WIFI …　有効/無効を切り替えます。デフォルトは有効です。無効にするとネットワーク機能が動作しなくなります。WIFIで接続エラーが出た場合、自動的にこの設定は「無効」に設定されます。
- SSID …　2.5GHzのSSIDを指定します。最大18文字です。
- PASSWORD　…　指定されたSSIDのパスワードです。


#### タッチパネルの調整
タッチパネルのタッチ位置と、実際にポイントされる位置がずれている場合、このメニューから調整します。
- タッチスクリーンの調整 …　タッチスクリーンの調整モードに入ります。調整モードに入ると終了するまで抜けることはできません。画面の左上、右上、右下、左下をそれぞれ１０回ずつタップします。タップした位置に丸が表示されます。調整モード中は以前の「ズレた状態」で動作しています。結果として、タップした丸も「ズレ」て表示されますが、気にせずにタップを続けてください。
- タッチスクリーンのテスト ... タッチスクリーンのテストモードに入ります。タッチした位置に丸が表示されます。タッチ位置の調整後などに使用し、ずれている場合タッチスクリーンの調整を行ってください。


---

## ライセンス

本プログラムはMITライセンスおよびAdafruitライブラリのライセンスに準拠します。

---


