@mainpage 雷センサー　AE-AS3935＋Raspberry pi PICO

# 雷センサー　AE-AS3935＋Raspberry pi PICO
## システム全体の概要

### 機能
- 雷雲を検出し、発見したら時刻と雷雲までの距離を表示します
- 起動時に、SNTPに対して日時を問い合わせ、時刻の設定を行います。


<img width=40% src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/2096509/399d4dba-28ba-48a6-8d24-44e05f9e788f.png">


### 特徴
- 時計が表示されるので常時電源ONでも違和感がない<br>通常は時計を表示し、時計として動作するようにします。レトロなムードとして、時計の文字盤はパタパタ時計にするなど、多少は見た目を気にしています。パタパタ時計なので秒針はありませんが、ランプの数で１５秒単位の秒はわかるようにしました。
- 自己完結している<br>設定画面を持ち、設定などでPCへの接続などを不要にしました。SSIDなどの文字入力時は、画面にソフトウェアキーボードを表示します。
- パラメータの調整可能<br/>AS3935のパラメータを設定可能にします。調整などでPCとの接続やコンパイルなどを不要にしました。各種キャリブレーションも、PCなどがなくても実行可能です。

## システム構成図
システムの概要は次の通りです。TFT液晶（表示とタッチスクリーン）はSPIで接続されています。雷センサはI2Cで接続されています。
雷センサーは割り込み要求ピンが１つ用意されており、雷の発生があると割り込みでマイコン側に伝えます。

<img width=60% src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/2096509/4f186b67-6f3e-4c35-bdfe-ffa1e0b886f7.png">


## ハードウェア

### AS-AE3935について

AS-AE3935は、AMS社のAS3935雷センサーICを搭載したモジュールで、雷の発生を検知し、雷雲までの距離や雷のエネルギーを推定できるデバイスです。秋月電子で販売されており、I2Cを使用して外部に情報を送信します。

主な特徴：
- 検出範囲：最大約40km先の雷を検知
- インターフェース：I²C（秋月電子のモジュールではSPIは未実装）
- 出力：雷検出時にIRQ信号を出力
- 電源電圧：2.4V〜5.5V
- 消費電流：待機時 約70μA、検出時 約350μA
- ノイズ除去機能：人工ノイズと自然雷を区別
- 距離推定：14段階で雷雲までの距離を出力

### 周辺回路について

今回のハードウェアは、Raspberry pi PICO Wをコントローラにして、[AE-AS3935](https://akizukidenshi.com/catalog/g/g108685/)と、ILI9341搭載の2.8インチSPITFT液晶、[MSP2807](https://akizukidenshi.com/catalog/g/g116265/)を使用した、雷センサーのプログラムです。

### 回路図とガーバーデータ

特筆するものはありません。Raspberry PI Picoにそのままポン付けしただけです。回路図ではI2Cに複数のデバイスを接続するためのピンソケットなどがありますが、実装する必要はありません。

<img width=80% src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/2096509/7d333592-0fa3-4069-920b-c1761f75a544.png">

Kicadの回路図、ボードデータとガーバーデータは[githubのプロジェクトページ](https://github.com/HisayukiNomura/AS3935APP/tree/main/KiCad)からダウンロードできます。

今回はブレッドボードの次、テスト用の片面基板などは作成せず、最初から両面基板で作りJLCPCBに発注しました。ボードは、10cmx10cmで作ってあります。ガーバーデータを使用してそのままPCBを発注することもでき、価格は５枚で$10未満だと思います。　[githubのプロジェクトページ](https://github.com/HisayukiNomura/AS3935APP/tree/main/KiCad)には、Gerber.zip という名前で発注に使用したガーバーデータをアップロードしてあります。



### 使用部品

使用している部品は次の通りです。型番、価格などは秋月電子のものです。（この中には、開発に使用するPCや、デバッグプローブなどは含まれていません。

|名前|型番|個数|単価|備考|
|---|---|---|---|---|
|Raspberry pi PICOW|SC0918|1|￥1,200|PICO 2W も可だが、再コンパイル必要|
|TFT液晶|MSP2807|1|￥1,450||
|雷センサー|AE-AS3935|1|￥2,280||
|ピンヘッダ 1x40|PH-1x40SG|4|￥35||
|カーボン抵抗 3.3KΩ|CF25J3K3B|4|￥1.4|１００個140円を購入|
|積層セラミックコンデンサ 0.1μF|RDER72A104K1K1H03B|1|￥12|１０個120円を購入|
|タクトスイッチ|DTS-63-N-V-BLK(TS-0606-F-N-BLK|5|￥15|代替品(DTS-63-F-N-V-RED(TS-0606-F-N-Rなど)でも可|
|ZIFソケット 40ピン|ULO-ZS431-40P1G|1|￥250|なくても可|

PCBを発注すると、その代金もあわせて￥7,000円くらいあれば、おつりが来ます。

スペックから察するに、おそらく、[雷探くん](https://www.amazon.co.jp/%E6%97%A5%E8%BE%B0%E9%9B%BB%E6%A9%9F%E8%A3%BD%E4%BD%9C%E6%89%80-%E9%9B%B7%E6%8E%A2%E3%81%8F%E3%82%93-NTD-P01/dp/B07Y4YNK15) が、同じシステムで動いていると思われます。こちらは￥15,306します。雷をLEDとビープ音で知らせるようです。

・・・しまった、ブザーくらいつけられるようにしておけばよかった・・・


## ソフトウェアの導入

Raspberry PI に、[githubのbuildフォルダ](https://github.com/HisayukiNomura/AS3935APP/tree/main/build)にある、AS3935APP.uf2を書き込んでください。

デバッグプローブを使用しても、USBから書き込んでも構いません。

書き込みが終わったらソフトウェアが起動しますが、初期状態では正しく動作しません。起動が完了したら、タイトルバー部分をタップし、設定画面に入り、次の設定を変更してください。

- I2Cアドレス　デフォルトは３です。秋月電子のモジュールは、I２Cアドレスが０のものと、３のものがあります。使用しているモジュールにあわせて変更します。
- ネットワーク設定　WIFIを有効にし、SSIDとパスワードを環境にあわせて変更してください。

変更方法の詳細は、ソフトウェア詳細を参照してください。


# ソフトウェア詳細


## 使用しているライブラリ

**グラフィック液晶ライブラリ**
[Rapberry PI Pico 用　ILI9341 TFT液晶 日本語ライブラリ](https://qiita.com/BUBUBB/items/7c6777c04dedf01d7c3b)

## 使用方法

プログラムが起動すると、初期化画面⇒監視画面へと進みます。監視画面から操作を行うと設定画面に移行します。

### 初期化画面


起動すると、最初に初期化画面が表示され、初期化の状況が表示されます。初期化が終わると自動的に次に進みます。

初期化される項目は次の通りです。初期化中の状態を確認し、×がある場合には問題を確認してください。

1. AS3935
2. WIFI初期化
3. WIFI接続
4. タイムゾーン取得
5. AS3935 のキャリブレーション

初期化中に、スクリーンをタッチし続けると、設定を初期化できます。設定がわからなくなってしまった時などに使用します。

### 監視画面

監視画面では時計が表示されます。雷を検知すると、画面に時刻、発生源と雷雲までの概算距離が表示されます。
画面最上部の、Wifiアイコンをタップすると、設定画面に移動します。

<img width=80% src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/2096509/040e4a44-a444-40cc-9fa9-7d1f8fbbc86a.png">


ここで表示される距離は実際に落雷があった場所までの距離示すものではありません。統計的に、雷雲の先端と現在位置の距離を算出したものです。

発生源は次のようになっています。
- なし　…　信号が存在しません。予期しない誤検出です。
- 雷　…　雷雲を検出しました。雷雲までの距離が表示されます。
- 距離超 …　雷雲を検出しましたが距離が遠すぎます。
- 距離０ …　雷雲を検出しましたが距離がゼロです。
- 誤信号 …　蛍光灯やモーターなどにより誤検出が発生しました。距離はーーーとなり表示されません。
- 雑音多 …　ノイズが多すぎて発生源を特定できません。NOISEFLR ノイズ下限水準を調整してください。


### 設定画面

#### メインメニュー

<img width=40% src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/2096509/f57a2b36-7983-4cc3-881c-ad6f3cd15b01.png">

- システム設定　…　時刻表示や現在日時の設定を行います
- AS3935設定 …　AS3935の各種パラメータを変更します。変更した後は再起動が必要になります。
- ネットワーク設定 …　WIFIの設定を行います。
- タッチパネルの調整 …　タッチパネルのキャリブレーションを行います。タッチ位置がずれていると感じたときに調整を行ってください。


#### システム設定

<img width=40% src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/2096509/6b1aabd6-7b43-413a-aeb0-049cb4e42355.png">


- 時刻表示　…　12H/24Hの切り替え。タップすると12時間表示と24時間表示が切り替わります。
- 日時　…　YYYYMMDDHHmmSS の形式で、現在時刻を指定します。たとえば2025/7/1 20:05:00 の場合、20250701200500　と入力します。
- デバッグ … ターミナル(TERM)となし(----)、を切り替えます。ターミナルを指定すると、実行状況がシリアル出力されます。シリアルポートはUART0で、GPIO0がTX、GPIO2がRX、ボーレートは115200です。

#### AS3935設定
ここでは、雷センサーに関する設定を行います。i2Cアドレスと読み込み方法の他は、主に雷センサーの感度調整や、ノイズの除去に関する設定です。


<img width=40% src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/2096509/03eeb93d-9333-43c8-83b9-2e23e5471c86.png">


- I2C addr …　I2Cアドレスを指定します。１～３が指定できます。デフォルトは３です。秋月電子のAE-AS3935は初期ロットは０、後期ロットは３です。
- ReadMode …　Single/Blockが指定できます。デフォルトはSingleです。SingleはI2Cリードを必要な場所ごとに分けて発行します。Blockは、すべてのレジスタを一回の読み込みで読み込みます。どちらを指定しても結果は同じです。Singleリードで正しく読み込めない場合、ブロックリードを指定します。ブロックリードをサポートしていないデバイスの場合Singleを指定します。
- GAINBOOST …　AFE（アナログフロントエンド）のゲインブースト値を０～３１で指定します。デフォルトは１８（屋内）です。屋外で使用する場合は１４を指定します。
- NOISEFLR …　ノイズ下限水準（ノイズフロアレベル）を０～７で指定します。デフォルト値は２です。この値と、AFEゲインブースト値で、ノイズ下限水準値が決定します。（例えば、デフォルト値である２で、AFEゲインブーストが18のときは、62μVrms）ノイズ下限水準より高いノイズが検出されるとノイズレベルが高すぎて動作ができないという信号が発生します。画面には「雑音多」と表示されます
- WATCHDOG … ウオッチドッグ閾値を０～１０で指定します。デフォルトは２です。ウオッチドックは、AFEが出力している検出信号を監視し、信号がウオッチドッグ閾値で指定された値を超えたら、その信号を検出モードに移行させます。検出モードでは、スパイクの除去などを行い、誤検出を排除します。<br>
ウオッチドッグ閾値を上げると、雑音などの誤検出に強くなりますが弱い雷の検出能力が下がります。<br>ウォッチドッグ閾値を下げると、ノイズの検出が増えますが逆に遠くの雷の検出能力が高くなります。
- MINLIGHT　…　雷の最小検出数を、１、５、９、１６で指定します。デフォルトは０です。雷の信号を検知しても、最新の１５分間以内にここで指定した数を超えないと、雷として検知しません。これは、人工的に発生するノイズによる誤警告を避けるための設定です。
- SPIKEREJ　…　スパイク除去設定を、０～１１で指定します。デフォルトは２です。
スパイク除去設定を上げると、雑音の除去が協力になり誤検出は減りますが、検出効率は下がります。<br>スパイク除去設定を下げると、雑音による誤検出が増えますが、検出効率は上がります。


#### ネットワーク設定
ここでは、WIFIに関する設定を行います。
<img width=40% src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/2096509/44394bf2-6a63-4f09-90a6-0f074be494f1.png">

- WIFI …　有効/無効を切り替えます。デフォルトは有効です。無効にするとネットワーク機能が動作しなくなります。WIFIで接続エラーが出た場合、自動的にこの設定は「無効」に設定されます。
- SSID …　2.5GHzのSSIDを指定します。最大18文字です。
- PASSWORD　…　指定されたSSIDのパスワードです。


#### タッチパネルの調整
タッチパネルのタッチ位置と、実際にポイントされる位置がずれている場合、このメニューから調整します。

<img width=40% src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/2096509/1cab0874-47c6-4ca5-b1b7-82cd664d75d9.png">


- タッチスクリーンの調整 …　タッチスクリーンの調整モードに入ります。調整モードに入ると終了するまで抜けることはできません。画面の左上、右上、右下、左下をそれぞれ１０回ずつタップします。タップした位置に丸が表示されます。調整モード中は以前の「ズレた状態」で動作しています。結果として、タップした丸も「ズレ」て表示されますが、気にせずにタップを続けてください。<br><img width=40% src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/2096509/0f4cc66c-7cda-4e3a-bea7-5348516574b8.png"><br/>
- タッチスクリーンのテスト ... タッチスクリーンのテストモードに入ります。タッチした位置に丸が表示されます。タッチ位置の調整後などに使用し、ずれている場合タッチスクリーンの調整を行ってください。<br><img width=40% src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/2096509/c0ba15f7-61a4-4cc2-907b-6ebae0364f5d.png">


### 設定画面での文字入力

設定画面は、タップすると順番に切り替わっていく項目のほか、スクリーンにキーボードが表示される入力項目もあります。

<img width=40% src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/2096509/e889cac0-9138-445f-92e1-b26fe6bff0e9.png">



#### 文字入力
文字入力では、画面にQWERTY配列のキーボードが表示されます。また、入力する部分にはブロックの点滅（挿入モード）/下線（上書きモード）のカーソルが表示されます。カーソルの初期位置は文字列の末尾です。

**キーボードの切り替え**
キーボード右下にある、"aA@" と書かれたキーをタップすると、入力する文字を切り替えることができます。
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/2096509/533f0c6b-b863-475e-a02b-841c55ba0f5d.png">

**特殊キー**
キーボードにはいくつか特別な動作をするキーがあります。
- ENTERキー。曲がった矢印のキーです。入力内容を決定するときに使用します
- DELキー。カーソルのある位置の文字を削除し右側にある文字を詰めます
- BSキー。カーソルのある位置の前の文字を削除します
- ESCキー。入力を中止します
- INSキー。挿入モードと上書きモードを切り替えます
- 左右キー。カーソルを左右に移動させます


#### 数字入力

日時の入力や、AS3935のパラメータなど、数字だけを受け付ける場合、テンキーパッドが表示されます。<br><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/2096509/30377611-5f61-4fde-b3fe-aa0a7025efab.png">

テンキーパッドが表示される場合、入力は常に上書きモードになり、カーソルは最初の１文字に配置されます。例えば、０２という値を０３にしたい場合、そのまま「０」「３」と値を上書き入力してください。






---

## ライセンス

本プログラムはMITライセンスおよびAdafruitライブラリのライセンスに準拠します。

---

